<!DOCTYPE html>
<html
        lang="vi"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="/client/account/layout"
>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Lịch sử đơn hàng</title>
</head>
<body>
<div class="order-history-content content card"
     th:with="orderStatusEnum=${T(com.laptopstore.ecommerce.util.constant.OrderStatusEnum)},
               sortDirectionEnum=${T(com.laptopstore.ecommerce.util.constant.SortDirectionEnum)},
               priceUtils=${T(com.laptopstore.ecommerce.util.PriceUtils)},
               orderClass=${T(com.laptopstore.ecommerce.model.Order)},
               dateTimeUtils=${T(com.laptopstore.ecommerce.util.DateTimeUtils)},
               paymentMethodEnum=${T(com.laptopstore.ecommerce.util.constant.PaymentMethodEnum)},
               paginationUtils=${T(com.laptopstore.ecommerce.util.PaginationUtils)},
               validSortBy=${paginationUtils.getValidSortBy(orderClass, orderFilterDto.sortBy, orderClass.DEFAULT_SORT_FIELD)}"
     layout:fragment="account-content">
    <h1 class="content-title">Lịch sử đơn hàng</h1>

    <!-- control panel -->
    <form class="control-panel-form" method="get" th:action="@{/account/order-history}">
        <input type="hidden" name="sortBy" th:value="${validSortBy}"/>

        <input type="hidden" name="sortDirection" th:value="${orderFilterDto.getEnumSortDirection()}"/>

        <!-- filters -->
        <div class="filters">
            <button class="show-modal-button show-filters-button primary-button"
                    data-show="filtersModal" type="button">
                <i class="fa-solid fa-filter"></i>
                Bộ lọc
                <span class="filter-number warning-badge" th:if="${orderFilterDto.getFilterCount() > 0}"
                      th:text="${orderFilterDto.getFilterCount()}"></span>
            </button>
            <div id="filtersModal" class="filters-modal modal">
                <div class="filters-modal-header modal-header">
                    <div class="header-title">Bộ lọc</div>
                    <button type="button" class="hide-modal-button" data-hide="filtersModal">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <div class="filters-modal-body modal-body">
                    <div class="filter-section">
                        <h2 class="filter-label">Thanh toán:</h2>
                        <div class="filter-options">
                            <div class="filter-check-group"
                                 th:each="paymentMethod: ${paymentMethodEnum.values()}">
                                <input type="checkbox" name="paymentMethods"
                                       th:id="${'method#' + paymentMethod}" th:value="${paymentMethod}"
                                       th:checked="${orderFilterDto?.paymentMethods?.contains(paymentMethod.name())}"/>
                                <label th:for="${'method#' + paymentMethod}" th:text="${paymentMethod}">
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h2 class="filter-label">Trạng thái:</h2>
                        <div class="filter-options">
                            <div class="filter-check-group"
                                 th:each="orderStatus: ${orderStatusEnum.values()}">
                                <input type="checkbox" name="statuses"
                                       th:id="${'status#' + orderStatus}" th:value="${orderStatus}"
                                       th:checked="${orderFilterDto?.statuses?.contains(orderStatus.name())}"/>
                                <label th:for="${'status#' + orderStatus}"
                                       th:text="${orderStatus.displayName}"></label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-section"
                         th:with="totalPriceRange=${priceUtils.getValidPriceRange(orderFilterDto.getDoubleMinTotalPrice(), orderFilterDto.getDoubleMaxTotalPrice(), orderFilterDto.MIN_TOTAL_PRICE, orderFilterDto.MAX_TOTAL_PRICE)}">
                        <h2 class="filter-label">Tổng giá tiền:</h2>
                        <div class="filter-options">
                            <div class="filter-input-group">
                                <label for="minTotalPrice">Từ: </label>
                                <input type="text" name="minTotalPrice" class="price-input"
                                       id="minTotalPrice"
                                       th:value="${!totalPriceRange.isEmpty() ? totalPriceRange.get('min') : orderFilterDto.MIN_TOTAL_PRICE}"/>
                            </div>

                            <div class="filter-input-group">
                                <label for="maxTotalPrice">Đến: </label>
                                <input type="text" name="maxTotalPrice" class="price-input"
                                       id="maxTotalPrice"
                                       th:value="${!totalPriceRange.isEmpty() ? totalPriceRange.get('max') : orderFilterDto.MAX_TOTAL_PRICE}"/>
                            </div>
                        </div>
                    </div>

                    <div class="filter-section"
                         th:with="instantRange=${dateTimeUtils.getValidInstantRange(orderFilterDto.getInstantStartDate(), orderFilterDto.getInstantEndDate())}">
                        <h2 class="filter-label">khoảng thời gian:</h2>
                        <div class="filter-options">
                            <div class="filter-input-group">
                                <label for="startDate">Từ: </label>
                                <input type="date" name="startDate" class="date-select" id="startDate"
                                       th:value="${!instantRange.isEmpty() ? #temporals.format(instantRange.get('startDate'), 'yyyy-MM-dd') : null }"/>
                            </div>

                            <div class="filter-input-group">
                                <label for="endDate">Đến: </label>
                                <input type="date" name="endDate" class="date-select" id="endDate"
                                       th:value="${!instantRange.isEmpty() ? #temporals.format(instantRange.get('endDate'), 'yyyy-MM-dd') : null }"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filters-modal-footer modal-footer">
                    <button type="submit" class="filters-apply-button primary-button">Áp dụng</button>
                    <a class="filters-reset-button secondary-button"
                       th:href="@{/account/order-history(
                                        page=1,
                                        sortBy=${validSortBy},
                                        sortDirection=${orderFilterDto.sortDirection},
                                        limit=${orderFilterDto.getLimit()},
                                        search=${orderFilterDto.search}

                                    )}"
                    >
                        Đặt lại
                    </a>
                </div>
            </div>
        </div>

        <!-- limit -->
        <div class="limit">
            <label class="limit-label" for="limit">Giới hạn:</label>
            <select class="limit-select" name="limit" id="limit" onchange="this.form.submit()">
                <option th:value="10" th:selected="${orderFilterDto.getIntegerLimit() == 10}">10
                </option>
                <option th:value="20" th:selected="${orderFilterDto.getIntegerLimit() == 20}">20
                </option>
                <option th:value="40" th:selected="${orderFilterDto.getIntegerLimit() == 40}">40
                </option>
                <option th:value="80" th:selected="${orderFilterDto.getIntegerLimit() == 80}">80
                </option>
            </select>
        </div>

        <!-- search -->
        <div class="search">
            <label style="display: none" for="search"></label>
            <input class="search-input" type="text" name="search" id="search"
                   th:value="${orderFilterDto.search}" placeholder="Mã đơn hàng..."/>
            <button type="submit" class="search-button"><i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>
    </form>

    <!-- search summary -->
    <div class="search-summary" th:if="${!#strings.isEmpty(orderFilterDto.search)}">
        <p class="search-message">
                    <span class="search-result-count" th:text="${response.totalItem}">
                    </span> Kết qua cho "<span class="search-value" th:text="${orderFilterDto.search}"></span>"
        </p>
        <a class="search-reset-link"
           th:href="@{/account/order-history(
                                page=1,
                                sortBy=${validSortBy},
                                sortDirection=${orderFilterDto.getSortDirection()},
                                limit=${orderFilterDto.getLimit()},
                                search='',
                                paymentMethods=${orderFilterDto.paymentMethods},
                                statuses=${orderFilterDto.statuses},
                                minTotalPrice=${orderFilterDto.minTotalPrice},
                                maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                startDate=${orderFilterDto.startDate},
                                endDate=${orderFilterDto.endDate}

                        )}">
            Đặt lại
        </a>
    </div>

    <div class="no-result" th:if="${response.data == null or #lists.isEmpty(response.data)}">
        <p>Không có đơn hàng nào</p>
    </div>

    <!-- table -->
    <div class="content-table table-container" th:if="${response.data != null and !#lists.isEmpty(response.data)}">
        <table class="table">
            <thead>
            <tr class="table-header-row">
                <th class="table-header-cell col-width-2"
                    th:with="sortDirection=${validSortBy.equals('createdAt') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC) ? 'ASC' : 'DESC'}">
                    <a th:href="@{/account/order-history(
                                        page=1,
                                        sortBy='createdAt',
                                        sortDirection=${sortDirection},
                                        limit=${orderFilterDto.getLimit()},
                                        search=${orderFilterDto.search},
                                        paymentMethods=${orderFilterDto.paymentMethods},
                                        statuses=${orderFilterDto.statuses},
                                        minTotalPrice=${orderFilterDto.minTotalPrice},
                                        maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                        startDate=${orderFilterDto.startDate},
                                        endDate=${orderFilterDto.endDate}
                                    )}">
                        Tạo lúc
                        <i th:if="${validSortBy.equals('createdAt') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC)}"
                           class="fa-solid fa-arrow-down"></i>
                        <i th:if="${validSortBy.equals('createdAt') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.ASC)}"
                           class="fa-solid fa-arrow-up"></i>
                    </a>
                </th>

                <th class="table-header-cell col-width-2"
                    th:with="sortDirection=${validSortBy.equals('id') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC) ? 'ASC' : 'DESC'}">
                    <a th:href="@{/account/order-history(
                                        page=1,
                                        sortBy='id',
                                        sortDirection=${sortDirection},
                                        limit=${orderFilterDto.getLimit()},
                                        search=${orderFilterDto.search},
                                        paymentMethods=${orderFilterDto.paymentMethods},
                                        statuses=${orderFilterDto.statuses},
                                        minTotalPrice=${orderFilterDto.minTotalPrice},
                                        maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                        startDate=${orderFilterDto.startDate},
                                        endDate=${orderFilterDto.endDate}
                                    )}">
                        Mã
                        <i th:if="${validSortBy.equals('id') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC)}"
                           class="fa-solid fa-arrow-down"></i>
                        <i th:if="${validSortBy.equals('id') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.ASC)}"
                           class="fa-solid fa-arrow-up"></i>
                    </a>
                </th>

                <th class="table-header-cell col-width-3"
                    th:with="sortDirection=${validSortBy.equals('totalPrice') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC) ? 'ASC' : 'DESC'}">
                    <a th:href="@{/account/order-history(
                                        page=1,
                                        sortBy='totalPrice',
                                        sortDirection=${sortDirection},
                                        limit=${orderFilterDto.getLimit()},
                                        search=${orderFilterDto.search},
                                        paymentMethods=${orderFilterDto.paymentMethods},
                                        statuses=${orderFilterDto.statuses},
                                        minTotalPrice=${orderFilterDto.minTotalPrice},
                                        maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                        startDate=${orderFilterDto.startDate},
                                        endDate=${orderFilterDto.endDate}
                                    )}">
                        Tổng giá trị
                        <i th:if="${validSortBy.equals('totalPrice') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC)}"
                           class="fa-solid fa-arrow-down"></i>
                        <i th:if="${validSortBy.equals('totalPrice') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.ASC)}"
                           class="fa-solid fa-arrow-up"></i>
                    </a>
                </th>

                <th class="table-header-cell col-width-2"
                    th:with="sortDirection=${validSortBy.equals('paymentMethod') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC) ? 'ASC' : 'DESC'}">
                    <a th:href="@{/account/order-history(
                                        page=1,
                                        sortBy='paymentMethod',
                                        sortDirection=${sortDirection},
                                        limit=${orderFilterDto.getLimit()},
                                        search=${orderFilterDto.search},
                                        paymentMethods=${orderFilterDto.paymentMethods},
                                        statuses=${orderFilterDto.statuses},
                                        minTotalPrice=${orderFilterDto.minTotalPrice},
                                        maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                        startDate=${orderFilterDto.startDate},
                                        endDate=${orderFilterDto.endDate}
                                    )}">
                        Thanh toán
                        <i th:if="${validSortBy.equals('paymentMethod') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC)}"
                           class="fa-solid fa-arrow-down"></i>
                        <i th:if="${validSortBy.equals('paymentMethod') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.ASC)}"
                           class="fa-solid fa-arrow-up"></i>
                    </a>
                </th>

                <th class="table-header-cell col-width-2"
                    th:with="sortDirection=${validSortBy.equals('status') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC) ? 'ASC' : 'DESC'}">
                    <a th:href="@{/account/order-history(
                                        page=1,
                                        sortBy='status',
                                        sortDirection=${sortDirection},
                                        limit=${orderFilterDto.getLimit()},
                                        search=${orderFilterDto.search},
                                        paymentMethods=${orderFilterDto.paymentMethods},
                                        statuses=${orderFilterDto.statuses},
                                        minTotalPrice=${orderFilterDto.minTotalPrice},
                                        maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                        startDate=${orderFilterDto.startDate},
                                        endDate=${orderFilterDto.endDate}
                                    )}">
                        Trạng thái
                        <i th:if="${validSortBy.equals('status') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.DESC)}"
                           class="fa-solid fa-arrow-down"></i>
                        <i th:if="${validSortBy.equals('status') and orderFilterDto.getEnumSortDirection().equals(sortDirectionEnum.ASC)}"
                           class="fa-solid fa-arrow-up"></i>
                    </a>
                </th>

                <th class="table-header-cell col-width-1"></th>
            </tr>
            </thead>
            <tbody>
            <tr class="table-body-row" th:each="order : ${response.data}">
                <td class="table-body-cell">
                                    <span class="cell-text"
                                          th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'dd-MM-yyyy') : 'N/A'}"></span>
                </td>

                <td class="table-body-cell">
                    <span class="cell-text" th:text="${order.id}"></span>
                </td>

                <td class="table-body-cell">
                                    <span class="cell-text"
                                          th:text="${order.totalPrice != null ? #numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT') + '₫' : 'N/A'}"></span>
                </td>

                <td class="table-body-cell">
                                    <span class="cell-text"
                                          th:text="${order.paymentMethod != null ? order.paymentMethod : 'N/A'}"></span>
                </td>

                <td class="table-body-cell" th:switch="${order.status}">
                                    <span th:case="${orderStatusEnum.PENDING}" class="secondary-badge"
                                          th:text="${order.status.displayName}"></span>

                    <span th:case="${orderStatusEnum.CONFIRMED}" class="primary-badge"
                          th:text="${order.status.displayName}"></span>

                    <span th:case="${orderStatusEnum.DELIVERED}" class="success-badge"
                          th:text="${order.status.displayName}"></span>

                    <span th:case="${orderStatusEnum.CANCELLED}" class="danger-badge"
                          th:text="${order.status.displayName}"></span>

                    <span th:case="*" th:text="'N/A'"></span>
                </td>

                <td class="table-body-cell">
                    <div class="table-row-actions">
                        <a class="view-details-button primary-button"
                           th:href="@{/account/order-history/details/{orderId}(orderId=${order.id})}">Xem</a>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- pagination -->
    <ul class="pagination" th:if="${response.totalPages > 1}">
        <!-- Previous Page -->
        <li class="pagination-item">
            <a class="button previous-page-button"
               th:href="@{/account/order-history(
                                page=${response.currentPage - 1},
                                sortBy=${validSortBy},
                                sortDirection=${orderFilterDto.getSortDirection()},
                                limit=${orderFilterDto.getLimit()},
                                search=${orderFilterDto.search},
                                paymentMethods=${orderFilterDto.paymentMethods},
                                statuses=${orderFilterDto.statuses},
                                minTotalPrice=${orderFilterDto.minTotalPrice},
                                maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                startDate=${orderFilterDto.startDate},
                                endDate=${orderFilterDto.endDate}
                            )}"
               th:classappend="${response.currentPage <= 1 ? 'disabled' : ''}"
            >
                <i class="fa-solid fa-chevron-left"></i>
            </a>
        </li>

        <!-- Page Numbers -->
        <li class="pagination-item"
            th:each="pageNumber : ${#numbers.sequence(1, response.totalPages)}">
            <a class="button page-number-button"
               th:href="@{/account/order-history(
                                page=${pageNumber},
                                sortBy=${validSortBy},
                                sortDirection=${orderFilterDto.getSortDirection()},
                                limit=${orderFilterDto.getLimit()},
                                search=${orderFilterDto.search},
                                paymentMethods=${orderFilterDto.paymentMethods},
                                statuses=${orderFilterDto.statuses},
                                minTotalPrice=${orderFilterDto.minTotalPrice},
                                maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                startDate=${orderFilterDto.startDate},
                                endDate=${orderFilterDto.endDate}
                            )}"
               th:classappend="${response.currentPage == pageNumber ? 'active' : ''}"
               th:text="${pageNumber}">
            </a>
        </li>

        <!-- Next Page -->
        <li class="pagination-item">
            <a class="button next-page-button"
               th:href="@{/account/order-history(
                                page=${response.currentPage + 1},
                                sortBy=${validSortBy},
                                sortDirection=${orderFilterDto.getSortDirection()},
                                limit=${orderFilterDto.getLimit()},
                                search=${orderFilterDto.search},
                                paymentMethods=${orderFilterDto.paymentMethods},
                                statuses=${orderFilterDto.statuses},
                                minTotalPrice=${orderFilterDto.minTotalPrice},
                                maxTotalPrice=${orderFilterDto.maxTotalPrice},
                                startDate=${orderFilterDto.startDate},
                                endDate=${orderFilterDto.endDate}
                            )}"
               th:classappend="${response.currentPage >= response.totalPages ? 'disabled' : ''}">
                <i class="fa-solid fa-chevron-right"></i>
            </a>
        </li>
    </ul>
</div>
</body>
</html>
